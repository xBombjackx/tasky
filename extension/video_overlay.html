<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Task Extension</title>
    <!-- The Twitch Extension Helper Library -->
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
   
    <style>
        /* Basic styling for visibility */
        body {
            font-family: sans-serif;
            background-color: transparent;
            color: white;
            padding: 20px;
        }
        #app {
            background-color: rgba(10, 10, 20, 0.8);
            padding: 15px;
            border-radius: 8px;
        }
        .task {
            padding: 5px;
            border-bottom: 1px solid #444;
        }
    </style>
</head>
<body>
    <div id="app">
        <h2>Live Tasks</h2>
        <div id="streamer-tasks"></div>
        <div id="viewer-tasks"></div>
        <div id="auth-status">Connecting to Twitch...</div>
    </div>

    <script>
        const twitch = window.Twitch.ext;
        const authStatusDiv = document.getElementById('auth-status');
        const streamerTasksDiv = document.getElementById('streamer-tasks');
        
        let authToken = null; // We will store the JWT here
        let userId = null; // We will store the user's ID here

        // This is the URL of our EBS
       const EBS_URL ='https://yummy-badgers-dream.loca.lt';
       
        // This function is called by Twitch when the extension is authorized
        
        twitch.onAuthorized(async (auth) => {
            console.log('Twitch authorization successful!');
            authStatusDiv.textContent = `Authenticated as user: ${auth.userId}`;
            
            // Save the token and user ID
            authToken = auth.token;
            userId = auth.userId;

            // Now that we're authorized, we can fetch the tasks
            await fetchTasks();
      });
           
     
        // This function fetches tasks from our backend
        async function fetchTasks() {
            if (!authToken) {
                console.error("Cannot fetch tasks, not authenticated yet.");
                return;
            }
            
            try {
                const response = await fetch(`${EBS_URL}/tasks`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        // We send our JWT with the request for verification
                        'Authorization': `Bearer ${authToken}` 
                    }
                });
                
                const data = await response.json();
                
                // Clear and render tasks
                streamerTasksDiv.innerHTML = '<h3>Streamer Tasks</h3>';
                data.streamerTasks.forEach(task => {
                    const el = document.createElement('div');
                    el.className = 'task';
                    el.textContent = `[ ] ${task.title}`;
                    streamerTasksDiv.appendChild(el);

                });
                 // TODO: Render viewer tasks similarly
                
            } catch (error) {
                console.error("Error fetching tasks:", error);
                authStatusDiv.textContent = "Error fetching tasks from backend.";
            }
        }
        
        // Listen for context changes (e.g., light/dark mode)
        twitch.onContext((context, changed) => {
            // console.log('Context changed:', context);
        });

    </script>
</body>
</html>
