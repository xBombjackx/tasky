<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Twitch Extension - Task Overlay</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="styles.css">
<script>
      const urlParams = new URLSearchParams(window.location.search);
      // We'll define the EBS_URL globally based on the 'local' param.
      let EBS_URL;

      if (urlParams.get('local') === 'true') {
        // For local testing, use the mock EBS and mock Twitch helper
        document.write('<script src="mock-twitch-ext.js"><\/script>');
        EBS_URL = "http://localhost:8082";
      } else {
        // For production/Twitch sandbox, use the real helper and EBS
        document.write('<script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"><\/script>');
        EBS_URL = "https://yummy-badgers-dream.loca.lt";
      }
    </script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#53a8b6",
                        "background-light": "#f6f5f8",
                        "background-dark": "#3a4f6a",
                        "text-light": "#bbe4e9",
                        "text-muted": "#79c2d0",
                        "border-color": "#5585b5",
                        "vip-glow": "#f6d55c",
                        "vip-bg": "rgba(246, 213, 92, 0.1)",
                        "subscriber": "#d68fd6",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.75rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
      @property --gradient-angle {
        syntax: "<angle>";
        initial-value: 0deg;
        inherits: false;
      }
      @keyframes gradient-spin {
        to { --gradient-angle: 360deg; }
      }
      .vip-task::before {
        content: '';
        position: absolute;
        z-index: -1;
        inset: -2px; /* Border thickness */
        border-radius: 1rem; /* Matches rounded-lg in your config */
        background: conic-gradient(from var(--gradient-angle), #d68fd6, #f6d55c, #53a8b6, #d68fd6);
        animation: gradient-spin 4s linear infinite;
      }
      .vip-task span, .vip-task p {
        /* Add a subtle outline using text-shadow to improve readability against the animated border */
        text-shadow: 0 0 4px #3a4f6a, 0 0 4px #3a4f6a;
      }
      /* Custom Scrollbar for Webkit browsers */
      #viewer-tasks::-webkit-scrollbar {
        width: 6px;
      }
      #viewer-tasks::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 3px;
      }
      #viewer-tasks::-webkit-scrollbar-thumb {
        background-color: #5585b5; /* border-color */
        border-radius: 3px;
      }
      #viewer-tasks::-webkit-scrollbar-thumb:hover {
        background-color: #53a8b6; /* primary */
      }

      /* Style for completed tasks */
      .group:has(input:checked) {
        filter: grayscale(80%) brightness(0.7);
        opacity: 0.7;
        transition: filter 0.3s ease, opacity 0.3s ease;
      }
    </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative min-h-screen p-4 sm:p-6 lg:p-8 flex items-start justify-end">
<div class="w-full max-w-sm bg-background-dark/80 dark:bg-background-dark/80 backdrop-blur-xl rounded-xl border border-border-color/50 shadow-2xl shadow-primary/10 flex flex-col gap-5 text-text-light p-5">
<div class="flex flex-col gap-2">
<div class="flex justify-between items-baseline">
<p class="text-base font-bold leading-normal text-text-light">Community Focus</p>
<p class="text-sm font-medium leading-normal text-text-muted" id="task-counter">0/0</p>
</div>
<div class="h-2.5 w-full bg-black/20 rounded-full overflow-hidden">
<div class="h-full bg-primary rounded-full" id="task-progress-bar" style="width: 0%;"></div>
</div>
</div>
<div class="h-px bg-border-color/50"></div>
<div>
<h3 class="text-lg font-extrabold leading-tight tracking-[-0.015em] text-text-light mb-3">Streamer Tasks</h3>
<div id="streamer-tasks" class="flex flex-col">
<!-- Streamer tasks will be dynamically inserted here -->
</div>
</div>
<div>
<h3 class="text-lg font-extrabold leading-tight tracking-[-0.015em] text-text-light mb-3">Viewer Tasks</h3>
<div id="viewer-tasks" class="flex flex-col max-h-[20rem] overflow-y-auto space-y-1 pr-1">
<!-- Viewer tasks will be dynamically inserted here -->
</div>
</div>
<div>
<h3 class="text-lg font-extrabold leading-tight tracking-[-0.015em] text-text-light mb-3">Bonus Goals</h3>
<div class="flex flex-col items-center justify-center py-6 px-4 text-center bg-black/20 rounded-xl">
<span class="material-symbols-outlined text-4xl text-text-muted">
                    checklist
                    </span>
<p class="text-sm font-medium text-text-muted mt-1">No bonus goals yet.</p>
</div>
</div>
</div>
</div>
<script>
      const twitch = window.Twitch.ext;
      const streamerTasksDiv = document.getElementById("streamer-tasks");
      const viewerTasksDiv = document.getElementById("viewer-tasks");

      let authToken = null;
      let userId = null;

      twitch.onAuthorized(async (auth) => {
        console.log("Twitch authorization successful!");
        authToken = auth.token;
        userId = auth.userId;
        await fetchTasks();
      });

      async function fetchTasks() {
        if (!authToken) {
          console.error("Cannot fetch tasks, not authenticated yet.");
          return;
        }

        try {
          const response = await fetch(`${EBS_URL}/tasks`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
          });

          const data = await response.json();

          updateTaskCounter(data.streamerTasks, data.viewerTasks);
          renderStreamerTasks(data.streamerTasks);
          renderViewerTasks(data.viewerTasks);

        } catch (error) {
          console.error("Error fetching tasks:", error);
        }
      }

      function updateCounterFromDOM() {
        const allTasks = document.querySelectorAll('#streamer-tasks input[type="checkbox"], #viewer-tasks input[type="checkbox"]');
        const completedTasks = document.querySelectorAll('#streamer-tasks input:checked, #viewer-tasks input:checked');
        const total = allTasks.length;
        const completed = completedTasks.length;
        const counterEl = document.getElementById("task-counter");
        const progressBarEl = document.getElementById("task-progress-bar");

        if (total > 0) {
          counterEl.textContent = `${completed}/${total}`;
          progressBarEl.style.width = `${(completed / total) * 100}%`;
        } else {
          counterEl.textContent = "0/0";
          progressBarEl.style.width = "0%";
        }
      }

      function updateTaskCounter(streamerTasks, viewerTasks) {
        const allTasks = [...streamerTasks, ...viewerTasks];
        const completedTasks = allTasks.filter(task => task.completed).length;
        const totalTasks = allTasks.length;

        const counterEl = document.getElementById("task-counter");
        const progressBarEl = document.getElementById("task-progress-bar");

        if (totalTasks > 0) {
          counterEl.textContent = `${completedTasks}/${totalTasks}`;
          progressBarEl.style.width = `${(completedTasks / totalTasks) * 100}%`;
        } else {
          counterEl.textContent = "0/0";
          progressBarEl.style.width = "0%";
        }
      }

      function renderStreamerTasks(tasks) {
        streamerTasksDiv.innerHTML = ""; // Clear existing tasks
        if (tasks.length === 0) {
            streamerTasksDiv.innerHTML = "<p>No streamer tasks yet.</p>";
            return;
        }
        tasks.forEach(task => {
            const el = document.createElement("label");
            el.className = "flex items-center gap-4 py-1.5 px-2 cursor-pointer group bg-black/20 rounded-lg";
            el.innerHTML = `
                <input type="checkbox" onchange="updateCounterFromDOM()" class="h-6 w-6 shrink-0 rounded-lg border-border-color border-2 bg-transparent text-primary checked:bg-primary checked:border-primary focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 focus:ring-offset-background-dark transition-all duration-200" ${task.completed ? 'checked' : ''}/>
                <p class="text-base font-medium leading-normal text-text-light group-hover:text-primary transition-colors">${task.title}</p>
            `;
            streamerTasksDiv.appendChild(el);
        });
      }

      function renderViewerTasks(tasks) {
          viewerTasksDiv.innerHTML = ""; // Clear existing tasks
          if (tasks.length === 0) {
              viewerTasksDiv.innerHTML = "<p>No viewer tasks yet.</p>";
              return;
          }
          tasks.sort((a, b) => {
            if (a.is_vip && !b.is_vip) return -1;
            if (!a.is_vip && b.is_vip) return 1;
            if (a.is_subscriber && !b.is_subscriber) return -1;
            if (!a.is_subscriber && b.is_subscriber) return 1;
            return 0;
          });
          tasks.forEach(task => {
              let el = document.createElement("div");
              if (task.is_vip) {
                el = document.createElement("label");
                el.htmlFor = `viewer-task-${task.id}`;
                el.className = "vip-task relative flex items-center gap-4 py-1.5 px-2 group bg-vip-bg rounded-lg cursor-pointer";
                el.innerHTML = `
                  <div class="flex-shrink-0">
                    <input type="checkbox" onchange="updateCounterFromDOM()" class="h-6 w-6 shrink-0 rounded-lg border-border-color border-2 bg-transparent text-primary checked:bg-primary checked:border-primary focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 focus:ring-offset-background-dark transition-all duration-200 peer" id="viewer-task-${task.id}" ${task.completed ? 'checked' : ''}/>
                  </div>
                  <div class="flex flex-col justify-center flex-1">
                      <span class="text-base font-bold leading-normal text-vip-glow">${task.title}</span>
                      <p class="text-sm font-normal leading-normal text-text-muted">by @${task.submitter}</p>
                  </div>
                  <span class="material-symbols-outlined text-3xl text-vip-glow">workspace_premium</span>
                `;
              } else if (task.is_subscriber) {
                el.className = "flex items-center gap-4 py-1.5 px-2 group bg-black/20 rounded-lg";
                el.innerHTML = `
                    <input type="checkbox" onchange="updateCounterFromDOM()" class="h-6 w-6 shrink-0 rounded-lg border-border-color border-2 bg-transparent text-primary checked:bg-primary checked:border-primary focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 focus:ring-offset-background-dark transition-all duration-200 peer" id="viewer-task-${task.id}" ${task.completed ? 'checked' : ''}/>
                    <div class="flex flex-col justify-center flex-1">
                        <label class="text-base font-medium leading-normal text-text-light cursor-pointer group-hover:text-primary transition-colors" for="viewer-task-${task.id}">${task.title}</label>
                        <p class="text-sm font-normal leading-normal text-text-muted">by @${task.submitter}</p>
                    </div>
                    <span class="material-symbols-outlined text-2xl text-subscriber">star</span>
                `;
              } else {
                el.className = "flex items-center gap-4 py-1.5 px-2 group bg-black/20 rounded-lg";
                el.innerHTML = `
                    <input type="checkbox" onchange="updateCounterFromDOM()" class="h-6 w-6 shrink-0 rounded-lg border-border-color border-2 bg-transparent text-primary checked:bg-primary checked:border-primary focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 focus:ring-offset-background-dark transition-all duration-200 peer" id="viewer-task-${task.id}" ${task.completed ? 'checked' : ''}/>
                    <div class="flex flex-col justify-center flex-1">
                        <label class="text-base font-medium leading-normal text-text-light cursor-pointer group-hover:text-primary transition-colors" for="viewer-task-${task.id}">${task.title}</label>
                        <p class="text-sm font-normal leading-normal text-text-muted">by @${task.submitter}</p>
                    </div>
                `;
              }
              viewerTasksDiv.appendChild(el);
          });
      }

      twitch.onContext((context, changed) => {
        // console.log('Context changed:', context);
      });
    </script>
</body></html>